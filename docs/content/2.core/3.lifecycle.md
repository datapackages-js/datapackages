---
title: Lifecycle Deep-Dive
description: Understanding the initialization, loading, and disposal phases of a Dataset.
---

# Lifecycle Deep-Dive

The `Dataset` system has a clearly defined lifecycle. Understanding these phases is crucial for building robust plugins and managing memory effectively.

## Lifecycle Phases

::mermaid
<pre>
sequenceDiagram
    participant User
    participant DS as Dataset
    participant MW as Middleware

    User->>DS: new MyDataset()
    User->>DS: .use(middleware)
    Note over DS,MW: Types are compounded
    
    User->>DS: .init()
    DS->>MW: onInit(dataset)
    DS->>DS: _load() (original or overridden)
    DS->>MW: onLoad(dataset, data)
    
    User->>DS: getAll() / search()
    
    User->>DS: .dispose()
    DS->>MW: dispose(dataset)
    Note right of DS: Timers cleared, data reset
</pre>
::

### 1. Construction & Configuration
When you instantiate a `Dataset`, it starts in an uninitialized state. You then apply middleware using `.use()`.

> [!TIP]
> **Type Safety**: `.use()` returns `this & TMethods`. Always chain your `.use()` calls before calling `.init()` to ensure full type visibility.

### 2. Initialization (`init`)
Calling `.init()` triggers the following sequence:
1. **`onInit` hooks**: All registered middlewares have their `onInit` hook called. This is where plugins should set up internal state or start initial background tasks.
2. **`load` phase**: The dataset calls its internal `load()` method. This might be intercepted by middleware (like `withCache` or `withStream`).
3. **`onLoad` hooks**: Once data is retrieved, middlewares can inspect or process the full dataset (e.g., to build a secondary index).

### 3. Usage Phase
After `init()`, the dataset is `ready`. You can now use methods like `getAll()`, `getById()`, or any methods added by plugins.

### 4. Cleanup (`dispose`)
The `dispose()` method is essential for long-running applications (like SPAs or servers).
- **Middleware Cleanup**: Triggers the `dispose` hook on all plugins.
- **Resource Management**: Plugins like `withLiveUpdate` use this to stop polling timers.
- **Memory**: Clears the internal `_dataStack` to allow garbage collection.

## Thread Safety & State
`Dataset.init()` is **idempotent**. If multiple `init()` calls happen simultaneously, the dataset ensures that:
- The actual loading logic only runs **once**.
- Subsequent callers wait for the same promise to resolve.
- Error states are tracked so failed initializations can be retried.
